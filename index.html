<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB Coin Page</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #222;
            border-radius: 0 0 20px 20px;
        }
        .top-bar h1 {
            margin: 0;
            font-size: 20px;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .coin-box {
            text-align: center;
            margin: 20px;
            padding: 20px;
            background-color: #333;
            border-radius: 20px;
        }
        .coin-box img {
            width: 150px;
            height: 150px;
        }
        .coin-count {
            font-size: 40px;
            margin: 10px 0;
        }
        .coin-text {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .tasks {
            text-align: center;
            margin: 20px;
            padding: 20px;
            background-color: #333;
            border-radius: 20px;
        }
        .tasks h3 {
            margin-bottom: 20px;
            font-size: 18px;
        }
        .task-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #444;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <h1>Welcome, <span id="telegramName">User</span></h1>
        <div class="user-info">
            <span id="telegramNameDisplay"></span>
            <img src="user.png" alt="User">
        </div>
    </div>

    <!-- Coin Box -->
    <div class="coin-box">
        <img src="coin.png" alt="Coin">
        <div class="coin-count" id="coinCount">0</div>
        <div class="coin-text">AB Coin</div>
    </div>

    <!-- Task Section -->
    <div class="tasks">
        <h3>Complete all tasks</h3>
        <div id="taskList">
            <!-- Task items will be added dynamically -->
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4tXjp6yj6W7JD5jC3mRxVYHcmjiZZHGM",
            authDomain: "ab-coin-695f3.firebaseapp.com",
            databaseURL: "https://ab-coin-695f3-default-rtdb.firebaseio.com",
            projectId: "ab-coin-695f3",
            storageBucket: "ab-coin-695f3.appspot.com",
            messagingSenderId: "373438391512",
            appId: "1:373438391512:web:b7f29d02587d48c130a3ad"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Set Telegram user's name and show AB Coin count
        const telegramName = new URLSearchParams(window.location.search).get("tgName");
        const telegramId = new URLSearchParams(window.location.search).get("tgId");

        // Display Telegram name
        const nameDisplay = document.getElementById('telegramName');
        const nameDisplayTop = document.getElementById('telegramNameDisplay');
        if (telegramName) {
            nameDisplay.textContent = telegramName;
            nameDisplayTop.textContent = telegramName;
        }

        // Load and display AB Coin from localStorage or Firebase
        const coinCountElement = document.getElementById('coinCount');
        const localCoin = localStorage.getItem('abcoin');

        if (localCoin) {
            coinCountElement.textContent = localCoin;
        } else {
            // If no local coin found, fetch from Firebase
            if (telegramId) {
                const userRef = ref(db, 'users/' + telegramId);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        coinCountElement.textContent = userData.abcoin || 0;
                        localStorage.setItem('abcoin', userData.abcoin || 0);
                    }
                });
            }
        }

        // Dynamically load tasks
        const taskList = document.getElementById('taskList');
        const tasksRef = ref(db, 'tasks/');
        get(tasksRef).then((snapshot) => {
            if (snapshot.exists()) {
                const tasks = snapshot.val();
                for (const taskId in tasks) {
                    const taskItem = document.createElement('div');
                    taskItem.classList.add('task-item');
                    taskItem.textContent = tasks[taskId].name;
                    taskList.appendChild(taskItem);
                }
            }
        });
    </script>
</body>
</html>
